@page "/"
@rendermode InteractiveServer
@using Models;

<PageTitle>CarCapture</PageTitle>

<form class="container" id="imageForm" @onsubmit="HandleSubmit">
    <div class="form-group">
        <label for="imageInput" id="customeImageUpload"><b id="inputText">Upload car image</b></label>
        <input type="file" id="imageInput" @onchange="HandleFileChange">
    </div>

    @{
        if(!loading)
        {
            <div id="loading">
                <img src="images/Loading.gif" />
            </div>
        }
        else if(!string.IsNullOrEmpty(inputImage))
        {
            <button type="submit" id="formSubmit">
                <b>Analyze</b>
            </button>
        }
        else
        {
            <div id="formSubmitEmpty">
                <b>Analyze</b>
            </div>
        }
    }
</form>

<div class="container bg-primary">
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Car</th>
                <th scope="col">Color</th>
                <th scope="col">License Plate</th>
            </tr>
        </thead>
        <tbody>
            @{
                // if(result.ColorList != null)
                // {
                //     foreach (var item in result.ColorList)
                //     {
                //         <tr>
                //             <td>
                //                 @item.CarScore
                //             </td>
                //             <td>
                //                 @item.Color
                //             </td>
                //         </tr>
                //     }
                // }
            }

            <tr>
                <td>
                    @inputImage
                </td>
            </tr>
        </tbody>
    </table>
</div>

@code {
    bool loading = true;
    string inputImage;

    public CarDetectorResult result;
    public HttpClient httpClient = new HttpClient();

    private async Task HandleSubmit(EventArgs e)
    {
        if (!string.IsNullOrEmpty(inputImage))
        {
            loading = true;

            var content = new StringContent($"\"{inputImage}\"", System.Text.Encoding.UTF8, "application/json");
            var response = await httpClient.PostAsync("https://localhost:7123/api/CarDetector/Detect", content);

            if(response.IsSuccessStatusCode)
            {
                result = await response.Content.ReadFromJsonAsync<CarDetectorResult>();
            }
            else
            {
                // Error
            }

            loading = false;
        }
    }

    private void HandleFileChange(ChangeEventArgs e)
    {
        inputImage = e.Value.ToString();
    }
}
